import React, { useState } from 'react';
import { Users, Search, Ticket, Plus, Trash2, Archive, Download, FileText } from 'lucide-react';

export default function SorteoOnline() {
  const [participantes, setParticipantes] = useState([]);
  const [nombreNuevo, setNombreNuevo] = useState('');
  const [busqueda, setBusqueda] = useState('');
  const [vistaActual, setVistaActual] = useState('registro');
  const [historialSorteos, setHistorialSorteos] = useState([]);
  const [nombreSorteo, setNombreSorteo] = useState('');

  // Generar 10 números aleatorios de 4 cifras únicos
  const generarNumeros = () => {
    const numeros = new Set();
    while (numeros.size < 10) {
      const numero = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      numeros.add(numero);
    }
    return Array.from(numeros).sort();
  };

  // Agregar nuevo participante
  const agregarParticipante = () => {
    if (nombreNuevo.trim() === '') {
      alert('Por favor ingresa un nombre');
      return;
    }

    const yaExiste = participantes.some(
      p => p.nombre.toLowerCase() === nombreNuevo.trim().toLowerCase()
    );

    if (yaExiste) {
      alert('Este participante ya está registrado');
      return;
    }

    const nuevoParticipante = {
      id: Date.now(),
      nombre: nombreNuevo.trim(),
      numeros: generarNumeros(),
      fecha: new Date().toLocaleString()
    };

    setParticipantes([...participantes, nuevoParticipante]);
    setNombreNuevo('');
  };

  // Eliminar participante
  const eliminarParticipante = (id) => {
    if (confirm('¿Estás seguro de eliminar este participante?')) {
      setParticipantes(participantes.filter(p => p.id !== id));
    }
  };

  // Archivar sorteo actual e iniciar uno nuevo
  const iniciarNuevoSorteo = () => {
    if (participantes.length === 0) {
      alert('No hay participantes para archivar');
      return;
    }

    const confirmacion = confirm(
      '¿Quieres archivar el sorteo actual e iniciar uno nuevo desde cero?\n\n' +
      'El sorteo actual se guardará en el historial y podrás consultarlo después.'
    );

    if (!confirmacion) return;

    const nombreDelSorteo = nombreSorteo || prompt(
      'Dale un nombre a este sorteo (ejemplo: "Sorteo Navidad 2024", "Sorteo Octubre"):', 
      `Sorteo ${new Date().toLocaleDateString()}`
    );

    if (!nombreDelSorteo) return;

    const sorteoArchivado = {
      id: Date.now(),
      nombre: nombreDelSorteo,
      participantes: [...participantes],
      fecha: new Date().toLocaleString(),
      totalParticipantes: participantes.length
    };

    setHistorialSorteos([sorteoArchivado, ...historialSorteos]);
    setParticipantes([]);
    setNombreSorteo('');
    setBusqueda('');
    setVistaActual('registro');
    
    alert('¡Sorteo archivado exitosamente! Puedes iniciar uno nuevo.');
  };

  // Eliminar sorteo del historial
  const eliminarSorteoHistorial = (id) => {
    if (confirm('¿Estás seguro de eliminar este sorteo del historial?')) {
      setHistorialSorteos(historialSorteos.filter(s => s.id !== id));
    }
  };

  // Exportar sorteo actual como texto
  const exportarSorteoActual = () => {
    if (participantes.length === 0) {
      alert('No hay participantes para exportar');
      return;
    }

    let texto = `═══════════════════════════════════════════════\n`;
    texto += `       ${nombreSorteo || 'SORTEO ACTUAL'}\n`;
    texto += `═══════════════════════════════════════════════\n`;
    texto += `Fecha de exportación: ${new Date().toLocaleString()}\n`;
    texto += `Total de participantes: ${participantes.length}\n`;
    texto += `═══════════════════════════════════════════════\n\n`;

    participantes.forEach((p, index) => {
      texto += `${index + 1}. ${p.nombre.toUpperCase()}\n`;
      texto += `   Registrado: ${p.fecha}\n`;
      texto += `   Números asignados:\n`;
      texto += `   ┌─────┬─────┬─────┬─────┬─────┐\n`;
      texto += `   │ ${p.numeros.slice(0, 5).join(' │ ')} │\n`;
      texto += `   ├─────┼─────┼─────┼─────┼─────┤\n`;
      texto += `   │ ${p.numeros.slice(5, 10).join(' │ ')} │\n`;
      texto += `   └─────┴─────┴─────┴─────┴─────┘\n\n`;
    });

    descargarTexto(texto, `sorteo-${Date.now()}.txt`);
  };

  // Exportar historial completo
  const exportarHistorial = () => {
    if (historialSorteos.length === 0) {
      alert('No hay sorteos en el historial para exportar');
      return;
    }

    let texto = `═══════════════════════════════════════════════\n`;
    texto += `       HISTORIAL DE SORTEOS\n`;
    texto += `═══════════════════════════════════════════════\n`;
    texto += `Exportado: ${new Date().toLocaleString()}\n`;
    texto += `Total de sorteos: ${historialSorteos.length}\n`;
    texto += `═══════════════════════════════════════════════\n\n`;

    historialSorteos.forEach((sorteo, idx) => {
      texto += `\n${'═'.repeat(50)}\n`;
      texto += `SORTEO ${idx + 1}: ${sorteo.nombre}\n`;
      texto += `${'═'.repeat(50)}\n`;
      texto += `Fecha: ${sorteo.fecha}\n`;
      texto += `Participantes: ${sorteo.totalParticipantes}\n`;
      texto += `${'─'.repeat(50)}\n\n`;

      sorteo.participantes.forEach((p, index) => {
        texto += `${index + 1}. ${p.nombre.toUpperCase()}\n`;
        texto += `   Números: ${p.numeros.join(' - ')}\n\n`;
      });
    });

    descargarTexto(texto, `historial-sorteos-${Date.now()}.txt`);
  };

  // Función auxiliar para descargar texto
  const descargarTexto = (texto, nombreArchivo) => {
    const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = nombreArchivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  // Filtrar participantes según búsqueda
  const participantesFiltrados = participantes.filter(p =>
    p.nombre.toLowerCase().includes(busqueda.toLowerCase()) ||
    p.numeros.some(num => num.includes(busqueda))
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Ticket className="w-10 h-10 text-purple-600" />
            <h1 className="text-3xl font-bold text-gray-800">Sistema de Sorteo Online</h1>
          </div>
          <p className="text-center text-gray-600 mb-4">
            Los datos se mantienen mientras no cierres esta pestaña
          </p>
          
          {/* Nombre del sorteo actual */}
          <div className="flex gap-2 items-center justify-center">
            <input
              type="text"
              value={nombreSorteo}
              onChange={(e) => setNombreSorteo(e.target.value)}
              placeholder="Nombre del sorteo actual (opcional)"
              className="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-center"
            />
          </div>
        </div>

        {/* Botones de acción principales */}
        <div className="grid grid-cols-2 gap-3 mb-6">
          <button
            onClick={iniciarNuevoSorteo}
            disabled={participantes.length === 0}
            className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white py-3 px-4 rounded-xl font-semibold shadow-lg transition-all flex items-center justify-center gap-2"
          >
            <Archive className="w-5 h-5" />
            Archivar y Nuevo Sorteo
          </button>
          <button
            onClick={exportarSorteoActual}
            disabled={participantes.length === 0}
            className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white py-3 px-4 rounded-xl font-semibold shadow-lg transition-all flex items-center justify-center gap-2"
          >
            <Download className="w-5 h-5" />
            Exportar Sorteo Actual
          </button>
        </div>

        {/* Tabs */}
        <div className="flex gap-2 mb-6">
          <button
            onClick={() => setVistaActual('registro')}
            className={`flex-1 py-3 px-6 rounded-xl font-semibold transition-all ${
              vistaActual === 'registro'
                ? 'bg-white text-purple-600 shadow-lg'
                : 'bg-white/30 text-white hover:bg-white/40'
            }`}
          >
            <Plus className="w-5 h-5 inline mr-2" />
            Registrar
          </button>
          <button
            onClick={() => setVistaActual('buscar')}
            className={`flex-1 py-3 px-6 rounded-xl font-semibold transition-all ${
              vistaActual === 'buscar'
                ? 'bg-white text-purple-600 shadow-lg'
                : 'bg-white/30 text-white hover:bg-white/40'
            }`}
          >
            <Search className="w-5 h-5 inline mr-2" />
            Buscar
          </button>
          <button
            onClick={() => setVistaActual('historial')}
            className={`flex-1 py-3 px-6 rounded-xl font-semibold transition-all ${
              vistaActual === 'historial'
                ? 'bg-white text-purple-600 shadow-lg'
                : 'bg-white/30 text-white hover:bg-white/40'
            }`}
          >
            <Archive className="w-5 h-5 inline mr-2" />
            Historial ({historialSorteos.length})
          </button>
        </div>

        {/* Vista de Registro */}
        {vistaActual === 'registro' && (
          <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <Users className="w-6 h-6 text-purple-600" />
              Registrar Nuevo Participante
            </h2>
            <div className="flex gap-3">
              <input
                type="text"
                value={nombreNuevo}
                onChange={(e) => setNombreNuevo(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && agregarParticipante()}
                placeholder="Nombre del participante"
                className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg"
              />
              <button
                onClick={agregarParticipante}
                className="bg-gradient-to-r from-purple-600 to-pink-500 text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all"
              >
                Agregar
              </button>
            </div>
            
            <div className="mt-6 p-4 bg-purple-50 rounded-xl">
              <p className="text-sm text-gray-700">
                <strong>Total de participantes:</strong> {participantes.length}
              </p>
            </div>
          </div>
        )}

        {/* Vista de Búsqueda */}
        {vistaActual === 'buscar' && (
          <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <Search className="w-6 h-6 text-purple-600" />
              Buscar Participante
            </h2>
            <input
              type="text"
              value={busqueda}
              onChange={(e) => setBusqueda(e.target.value)}
              placeholder="Busca por nombre o número..."
              className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg"
            />
          </div>
        )}

        {/* Vista de Historial */}
        {vistaActual === 'historial' && (
          <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <Archive className="w-6 h-6 text-purple-600" />
                Historial de Sorteos
              </h2>
              {historialSorteos.length > 0 && (
                <button
                  onClick={exportarHistorial}
                  className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2"
                >
                  <FileText className="w-4 h-4" />
                  Exportar Todo
                </button>
              )}
            </div>
            {historialSorteos.length === 0 ? (
              <p className="text-gray-500 text-center py-8">No hay sorteos archivados todavía</p>
            ) : (
              <div className="space-y-4">
                {historialSorteos.map((sorteo) => (
                  <div key={sorteo.id} className="border-2 border-gray-200 rounded-xl p-4 hover:border-purple-300 transition-all">
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <h3 className="font-bold text-lg text-gray-800">{sorteo.nombre}</h3>
                        <p className="text-sm text-gray-500">
                          {sorteo.fecha} • {sorteo.totalParticipantes} participantes
                        </p>
                      </div>
                      <button
                        onClick={() => eliminarSorteoHistorial(sorteo.id)}
                        className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                    <details className="cursor-pointer">
                      <summary className="text-purple-600 font-semibold hover:text-purple-700">
                        Ver participantes ({sorteo.participantes.length})
                      </summary>
                      <div className="mt-3 space-y-2 max-h-64 overflow-y-auto">
                        {sorteo.participantes.map((p) => (
                          <div key={p.id} className="bg-gray-50 p-3 rounded-lg">
                            <p className="font-semibold text-gray-800">{p.nombre}</p>
                            <div className="flex flex-wrap gap-2 mt-2">
                              {p.numeros.map((num, idx) => (
                                <span key={idx} className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-sm font-mono">
                                  {num}
                                </span>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </details>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Lista de Participantes (solo en vista registro y buscar) */}
        {(vistaActual === 'registro' || vistaActual === 'buscar') && (
          <div className="space-y-4">
            {participantesFiltrados.length === 0 ? (
              <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
                <p className="text-gray-500 text-lg">
                  {participantes.length === 0
                    ? 'No hay participantes registrados'
                    : 'No se encontraron resultados'}
                </p>
              </div>
            ) : (
              participantesFiltrados.map((participante) => (
                <div
                  key={participante.id}
                  className="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all"
                >
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <h3 className="text-2xl font-bold text-gray-800">
                        {participante.nombre}
                      </h3>
                      <p className="text-sm text-gray-500">
                        Registrado: {participante.fecha}
                      </p>
                    </div>
                    <button
                      onClick={() => eliminarParticipante(participante.id)}
                      className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>
                  
                  <div className="border-t-2 border-gray-100 pt-4">
                    <p className="text-sm font-semibold text-gray-600 mb-3">
                      Números asignados:
                    </p>
                    <div className="grid grid-cols-5 gap-3">
                      {participante.numeros.map((numero, idx) => (
                        <div
                          key={idx}
                          className="bg-gradient-to-br from-purple-500 to-pink-500 text-white font-bold text-xl py-3 px-4 rounded-xl text-center shadow-md"
                        >
                          {numero}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        )}
      </div>
    </div>
  );
}